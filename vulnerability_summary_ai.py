import os
import json
import google.generativeai as genai
from pathlib import Path
from dotenv import load_dotenv

# --- Configura√ß√£o ---

# Carrega as vari√°veis de ambiente do arquivo .env na raiz do projeto
dotenv_path = Path.cwd() / '.env'
load_dotenv(dotenv_path=dotenv_path)

# Pega a chave de API da vari√°vel de ambiente
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
if not GEMINI_API_KEY:
    print("Erro: A vari√°vel de ambiente GEMINI_API_KEY n√£o foi encontrada no arquivo .env.")
    print(f"Verifique se o arquivo '{dotenv_path}' existe e cont√©m a chave.")
    exit(1)

genai.configure(api_key=GEMINI_API_KEY)

# Diret√≥rio onde os logs est√£o localizados
LOGS_DIR = Path.cwd() / "logs"
LOG_PATTERNS = ["snyk*.log", "semgrep*.log", "gitleaks*.log",
                "bandit*.log", "grype*.log"]

# Diret√≥rio onde os relat√≥rios est√£o localizados
REPORTS_DIR = Path.cwd() / "reports"
DEPENDENCY_CHECK_REPORT = "dependency-check-report.json"
GRYPE_REPORT = "grype-vulnerabilities.json"

# --- Fun√ß√µes ---


def read_log_files():
    """L√™ o conte√∫do dos arquivos de log de vulnerabilidade."""
    log_contents = {}
    print(f"Procurando por logs em: {LOGS_DIR}")

    for pattern in LOG_PATTERNS:
        found_files = list(LOGS_DIR.glob(pattern))
        if not found_files:
            print(f"  - Nenhum log encontrado para o padr√£o: {pattern}")
            continue

        for log_file in found_files:
            try:
                print(f"  - Lendo o arquivo de log: {log_file.name}")
                content = log_file.read_text(encoding="utf-8")
                log_contents[log_file.name] = content
            except Exception as e:
                print(f"    Erro ao ler o arquivo {log_file.name}: {e}")

    return log_contents


def read_grype_report():
    """L√™ o relat√≥rio JSON do Grype."""
    report_path = REPORTS_DIR / GRYPE_REPORT

    if not report_path.exists():
        print(f"  - Relat√≥rio Grype n√£o encontrado: {report_path}")
        return None

    try:
        print(f"  - Lendo relat√≥rio Grype: {report_path.name}")
        with open(report_path, 'r', encoding='utf-8') as f:
            data = json.load(f)

        # Extrair informa√ß√µes de vulnerabilidades
        matches = data.get('matches', [])
        total_vulns = len(matches)
        severity_count = {'Critical': 0, 'High': 0, 'Medium': 0, 'Low': 0}

        vulnerabilities_summary = []
        for match in matches:
            vuln = match.get('vulnerability', {})
            artifact = match.get('artifact', {})

            severity = vuln.get('severity', 'Unknown')
            if severity in severity_count:
                severity_count[severity] += 1

            vulnerabilities_summary.append({
                'package': artifact.get('name', 'Unknown'),
                'version': artifact.get('version', 'Unknown'),
                'vulnerability_id': vuln.get('id', 'N/A'),
                'severity': severity,
                'description': vuln.get('description', 'No description'),
                'fix_versions': vuln.get('fix', {}).get('versions', []),
                'urls': vuln.get('urls', [])
            })

        return {
            'total_vulnerabilities': total_vulns,
            'severity_count': severity_count,
            'vulnerabilities': vulnerabilities_summary
        }

    except Exception as e:
        print(f"    Erro ao ler o relat√≥rio Grype: {e}")
        return None


def read_dependency_check_report():
    """L√™ o relat√≥rio JSON do OWASP Dependency-Check."""
    report_path = LOGS_DIR / DEPENDENCY_CHECK_REPORT

    if not report_path.exists():
        print(f"  - Relat√≥rio Dependency-Check n√£o encontrado: {report_path}")
        return None

    try:
        print(f"  - Lendo relat√≥rio Dependency-Check: {report_path.name}")
        with open(report_path, 'r', encoding='utf-8') as f:
            data = json.load(f)

        # Extrair informa√ß√µes relevantes para o resumo
        vulnerabilities_summary = []
        total_deps = len(data.get('dependencies', []))
        total_vulns = 0
        severity_count = {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0}

        for dep in data.get('dependencies', []):
            if 'vulnerabilities' in dep:
                dep_vulns = dep['vulnerabilities']
                total_vulns += len(dep_vulns)

                for vuln in dep_vulns:
                    severity = vuln.get('severity', 'UNKNOWN')
                    if severity in severity_count:
                        severity_count[severity] += 1

                    # Obter descri√ß√£o de forma segura
                    desc = vuln.get('description', 'No description')
                    if len(desc) > 200:
                        desc = desc[:200] + "..."

                    vulnerabilities_summary.append({
                        'file': dep.get('fileName', 'Unknown'),
                        'cve': vuln.get('name', 'N/A'),
                        'severity': severity,
                        'description': desc,
                        'cwes': [cwe.get('name') for cwe in
                                 vuln.get('cwes', []) if isinstance(cwe, dict)]
                    })

        return {
            'total_dependencies': total_deps,
            'total_vulnerabilities': total_vulns,
            'severity_count': severity_count,
            'vulnerabilities': vulnerabilities_summary
        }

    except Exception as e:
        print(f"    Erro ao ler o relat√≥rio Dependency-Check: {e}")
        return None


def get_vulnerability_summary(logs, dependency_report, grype_report):
    """
    Envia logs e relat√≥rios para an√°lise com Gemini.
    """
    if not logs and not dependency_report and not grype_report:
        return "Nenhum conte√∫do foi encontrado para an√°lise."

    # Prompt atualizado para incluir todas as ferramentas de seguran√ßa
    prompt_parts = [
        "Por favor, atue como um especialista em seguran√ßa de aplica√ß√µes",
        "e analise os seguintes dados de ferramentas de seguran√ßa:",
        "Snyk, Semgrep, Gitleaks, Bandit, OWASP Dependency-Check e Grype.",
        "",
        "Forne√ßa um resumo detalhado das vulnerabilidades encontradas,",
        "**formatado como um relat√≥rio em Markdown (.md)**.",
        "",
        "Use os seguintes emojis para indicar os n√≠veis de severidade:",
        "  - üö® Cr√≠tica",
        "  - üü† Alta",
        "  - üü° M√©dia",
        "  - üîµ Baixa",
        "",
        "Estruture o relat√≥rio com t√≠tulos (#), subt√≠tulos (##),",
        "listas (-) e blocos de c√≥digo (```) para os trechos relevantes.",
        "",
        "Para cada vulnerabilidade, inclua:",
        "1. **Descri√ß√£o do problema.**",
        "2. **Arquivo e linha** onde foi encontrada.",
        "3. **Sugest√£o de corre√ß√£o.**",
        ""
    ]

    # Adicionar dados do Grype se dispon√≠vel
    if grype_report:
        total_vulns = grype_report['total_vulnerabilities']
        severity_count = grype_report['severity_count']

        prompt_parts.extend([
            "--- GRYPE VULNERABILITY REPORT ---",
            f"Total de vulnerabilidades: {total_vulns}",
            f"Vulnerabilidades Critical: {severity_count['Critical']}",
            f"Vulnerabilidades High: {severity_count['High']}",
            f"Vulnerabilidades Medium: {severity_count['Medium']}",
            f"Vulnerabilidades Low: {severity_count['Low']}",
            "",
            "### Principais Vulnerabilidades (Grype):",
        ])

        # Adicionar as vulnerabilidades mais cr√≠ticas do Grype
        critical_vulns = [v for v in grype_report['vulnerabilities']
                          if v['severity'] in ['Critical', 'High']][:10]

        for vuln in critical_vulns:
            vuln_info = (
                f"- **{vuln['vulnerability_id']}** ({vuln['severity']}) "
                f"em {vuln['package']} {vuln['version']}")
            prompt_parts.append(vuln_info)
            prompt_parts.append(f"  Descri√ß√£o: {vuln['description'][:200]}...")
            if vuln['fix_versions']:
                fixes = ', '.join(vuln['fix_versions'][:3])
                prompt_parts.append(f"  Fix: {fixes}")
            prompt_parts.append("")

    # Adicionar dados do Dependency-Check se dispon√≠vel
    if dependency_report:
        total_deps = dependency_report['total_dependencies']
        total_dep_vulns = dependency_report['total_vulnerabilities']
        dep_severity = dependency_report['severity_count']

        prompt_parts.extend([
            "--- DEPENDENCY-CHECK REPORT ---",
            f"Total de depend√™ncias: {total_deps}",
            f"Total de vulnerabilidades: {total_dep_vulns}",
            f"Vulnerabilidades CRITICAL: {dep_severity['CRITICAL']}",
            f"Vulnerabilidades HIGH: {dep_severity['HIGH']}",
            f"Vulnerabilidades MEDIUM: {dep_severity['MEDIUM']}",
            f"Vulnerabilidades LOW: {dep_severity['LOW']}",
            "",
            "### Principais Vulnerabilidades:",
        ])

        # Adicionar as 10 vulnerabilidades mais cr√≠ticas
        critical_vulns = [v for v in dependency_report['vulnerabilities']
                          if v['severity'] in ['CRITICAL', 'HIGH']][:10]

        for vuln in critical_vulns:
            prompt_parts.append(
                f"- **{vuln['cve']}** ({vuln['severity']}) em {vuln['file']}")
            prompt_parts.append(f"  Descri√ß√£o: {vuln['description']}")
            if vuln['cwes']:
                prompt_parts.append(f"  CWEs: {', '.join(vuln['cwes'])}")
            prompt_parts.append("")

    # Adicionar logs das outras ferramentas
    if logs:
        prompt_parts.append("--- SECURITY TOOLS LOGS ---")
        for filename, content in logs.items():
            prompt_parts.append(f"\n--- Log: {filename} ---")
            prompt_parts.append(content)

    prompt = "\n".join(prompt_parts)

    print("\nGerando relat√≥rio com IA do Gemini...")
    try:
        model = genai.GenerativeModel('gemini-1.5-flash')
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        return f"## üö® Erro ao Gerar Relat√≥rio\n\n{e}"

# --- Execu√ß√£o Principal ---


def main():
    """Fun√ß√£o principal que orquestra a execu√ß√£o do script."""
    print("ü§ñ Iniciando gerador de relat√≥rio de vulnerabilidades com IA...")

    # Ler logs das ferramentas de seguran√ßa
    log_data = read_log_files()

    # Ler relat√≥rio do Dependency-Check
    dependency_data = read_dependency_check_report()

    # Ler relat√≥rio do Grype
    grype_data = read_grype_report()

    if not log_data and not dependency_data and not grype_data:
        print("\n‚ÑπÔ∏è Nenhum arquivo relevante encontrado. Pulando.")
        return

    summary_md = get_vulnerability_summary(
        log_data, dependency_data, grype_data)

    # Define o caminho do diret√≥rio de relat√≥rios
    reports_dir = Path.cwd() / "reports"
    reports_dir.mkdir(exist_ok=True)

    # Define o nome do arquivo de sa√≠da
    report_path = reports_dir / "vulnerability_summary.md"

    try:
        report_path.write_text(summary_md, encoding="utf-8")
        print("üìã Resultados salvos em reports/vulnerability_summary.md")
    except Exception as e:
        print(f"\n‚ùå Erro ao salvar o arquivo de relat√≥rio: {e}")
        exit(1)


if __name__ == "__main__":
    main()
